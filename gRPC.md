Step by step to create gRPC server

# Installation:

download protocol buffer(protobuf) compiler the gRPC tool, in my case using Mac/Linux:

```shell
    brew install protobuf
```

and check installation

```shell
    protof --version
```

Now to generate Golang code we need install two more plugin to the compiler

protoc-gen-go will help us to generate GO code to any request/response data message defiend on the protobuf

```shell
    go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
```

and check installation

```shell
    protoc-gen-go --version
```

protoc-gen-go-grps will help generate GO code that work with the gRPC framework

```shell
    go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
```

and check installation

```shell
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2
```

Update the PATH so that the protoc compiler can find the plugins just installed:

```shell
    export PATH="$PATH:$(go env GOPATH)/bin"
```

# Start coding

Inside the ./proto folder is stored all the protobuf files with the proto code

create the ./proto/users.proto to create the user message and ./proto/rpc_create_user.proto to create the rpc for the create user endpoint.
now, craete the service_simple_bank.proto to declare the rpc just created and repeate the same process for the login user endpoint

Now, add the proto command to the MakeFile folder in order to compile the proto files and create the golang code:

- Make sure that:
  - the `--proto_path` is pointing the proto folder
  - the `--go_out` and `--go-grpc-out` is pointing to the defined package on the proto files (`pb` in this case)
  - the last portion is pointing to all our proto files, in this case all the proto files inside the proto folder

```shell
    rm -f pb/*.go # <- This is to clean the pb folder before add more files
    protoc --proto_path=proto --go_out=pb --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    proto/*.proto
```

the `./pb` folder should be generated
probablt, some modules will be on the created files that are not on the `go.mod` and throw errors. To fix that run the `go mod tidy` command

Inside the gapi folder will be located the api logic but providing gRPC requests and responses.
Instead of routes, there will be located the functions with the logic to use the code generated by protobuf.

Now, add the logic in main to receive the gRPC requests

Install the evans cli in order to make gRPC requests since the console with the command:

```shell
    brew tap ktr0731/evans
```

and

```shell
    brew install evans
```

run the evans on the specified port with:

```shell
    evans --host localhost --port 9090 -r repl
```

use the pb package

```shell
    package pb
```

use the SimpleBank service

```shell
    service SimpleBank
```

# gRPC gateway

within the `tool` folder we will be located the modules to install the binary plugins on the GOBIN folder

then run `go mod tidy`

in order to install all the binaries should run the command:

```shell
    go install \
    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway \
    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2 \
    google.golang.org/protobuf/cmd/protoc-gen-go \
    google.golang.org/grpc/cmd/protoc-gen-go-grpc
```

To generate the stubs and make changes to the proto files we need to install the google dependencies.
First we need install the repo:

```git
    git clone git@github.com:googleapis/googleapis.git
```

Then, copy the same fields structure that they implement in order to use the dependencies
check the folders and search the `google` fodler that we need

```shell
    ls -l
```

copy the file to our proto file within the project
beeing on the google folder

```shell
    cp google/api/annotations.proto ~/GolangProjects/simple_bank/proto/google/api/
```

and repeate the same with the next files:

- google/api/field_behavior.proto
- google/api/http.proto
- google/api/httpbody.proto

Now we can use that modules to create the customs http endpoints in this example:

```proto
    option (google.api.http) = {
            post: "/v1/create_user"
            body: "*"
    }
```

Now we need change to make-proro protocol so can generate the stubs gRPC and the gateway adding the option `--grpc-gateway_out=pb` to add the http to the pb folder and `--grpc-gateway_opt=paths=source_relative` to store the generated files on the route folder of the project

Next, let's create the logic to start the gateway, will be located inside the `runGatewatServer()` functions.
In order the run both the gateway and grpc, we need to run them in differents goroutines so the first doesn't block the second.

## Using proto names

If we want to allow snake case or the same output names the we defined on our proto files to receive the information in to our grpc gateway, we need add the next code to allow it

```go
    jsonFormat := runtime.NewServeMux(
	runtime.WithMarshalerOption(runtime.MIMEWildcard, &runtime.JSONPb{
		MarshalOptions: protojson.MarshalOptions{
			UseProtoNames: true,
		},
		UnmarshalOptions: protojson.UnmarshalOptions{
			DiscardUnknown: true,
		},
	}),
)

```

[Here](https://grpc-ecosystem.github.io/grpc-gateway/docs/mapping/customizing_your_gateway/) are more resources in case that more customization are wanted

<h2>Adding open api documentation based on our grpc server</h2>

We need to add the `--openapiv2_out=doc/swagger` to generate the json files inside our `./doc/swager` folder, `--openapiv2_opt=allow_merge=true,merge_file_name=simple_bank` to generate all the JSON on the same file called simple_bank to our make proto command to generate the openapi json

In order the automatically add the name, contact and more information, we can specify this in our server.
To do so, first we need copy some files as we did before in order to use them on our proto service file. We should use the ... file of [this folder](git@github.com:grpc-ecosystem/grpc-gateway.git)
Beeing on the `./grpc-gateway/protoc-gen-openapiv2/option` we can run the next command to copy the neccesary files

```shell
    cp *.proto ~/GolandProjects/simple_bank/proto/protoc-gen-openapiv2/options
```

Cool, all the json was created successfull to generate the json with the information about the API. Now we need to create the UI to show it.
We can do so copying the same styles and html used and proporcioned by `swagger-api` on this [repo](git@github.com:swagger-api/swagger-ui.git)
Let's clone it

```shell
    git clone git@github.com:swagger-api/swagger-ui.git && cd swagger-ui
```

We need to copy the `dist` folder that contains all the components that we need

```shell
    cp -r dist/* ~/GolangProjects/simple_bank/doc/swagger
```

Inside the `/swagger-initializer.js` file we need to point the `SwaggerUIBundle`.url to our openapi json

Now we need add some extra code in to our `runGatewayServer` so we can handle that UI.

```go
	fs := http.FileServer(http.Dir("./doc/swagger")) // File that contain the ui portion
	mux.Handle("/swagger/", http.StripPrefix("/swagger/", fs)) // the /swagger endpoint will show that ui
```

Now we have a lot of frontend files that we need to load into our `.Dockerfile` and this can be annoying. To fix this we can use the module `statik` to load a binary based on the frontend files so we can use just that file to load into our docker file.
Another approach is that since the static files will be located in the binary backend, all will be loaded on the server memory that has speciall effects

Inside the `tools.go` file paste the blank module `github.com/rakyll/statik`
After run the `go mod tidy` to install the dependencies on our projects and `go install github.com/rakyll/statik` to install the cli so we can run the `statik` command, we can add the command to generate the binary after each time that the frontend swager changed.
`statik -src=./doc/swagger` to create the binary based on the files on that path and `-dest=./doc` to push the binary in that location

Add the blank module on the `main.go` file so the `init()` functions will be called when the server run (`_ github.com/santinofajardo/simpleBank/doc/statik`).
Made changes on the `runGatewayServer()` so we can use this binary file instead of the entire folder

```go
	staticFs, err := fs.New()
	if err != nil {
		log.Fatal("cannot create statik fs")
	}

	swaggerHandler := http.StripPrefix("/swagger/", http.FileServer(staticFs))
	mux.Handle("/swagger/", swaggerHandler)
```

We cann add more information ass the name, some description of the endpoint so can be used by the openapi to show it.
Here an example:

```proto
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            description: "Use this API to create a new user";
            summary: "Create a new user";
            external_docs: {
              url: "https://github.com/grpc-ecosystem/grpc-gateway";
              description: "Find out more Echo";
        };
        }
```
